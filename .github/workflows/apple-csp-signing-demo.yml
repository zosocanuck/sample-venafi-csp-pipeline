name: apple-csp-signing-demo
on: workflow_dispatch

env:
  SIGNING_CERTIFICATE: "Apple Development: Ivan Wallis (W98N684K7V)"
  TPP_AUTH_URL: ${{ secrets.TPP_AUTH_URL }}
  TPP_HSM_URL: ${{ secrets.TPP_HSM_URL }}
  TPP_USERNAME: sample-demo-user
  TPP_PASSWORD: ${{ secrets.TPP_DEMO_PASSWORD }}

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: gitlab.com/ivan.wallis/apple-csp-signing-demo
          token: ${{ secrets.GITLAB_TOKEN }}
      - name: Sign with xcode
        run: |
          tkdriverconfig getgrant --authurl=${{ env.TPP_AUTH_URL }} --hsmurl=${{ env.TPP_HSM_URL }} --username=${{ env.TPP_USERNAME }} --password=${{ env.TPP_DEMO_PASSWORD }} --hsmurl=${{
          tkdriverconfig sync
          codesign --force -o runtime --sign "${{ env.SIGNING_CERTIFICATE }}" archives.xcarchive/Products/Applications/SampleIOSApp.app
